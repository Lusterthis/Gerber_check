# 图像处理修复说明

## 问题描述
后端处理完图片返回给前端会变成黑白色，且风格与预期不同。

## 问题根因分析

通过对比参考代码和当前后端实现，发现了以下关键问题：

### 1. 缺少ImageNet反归一化处理
- **问题**：后端直接对模型输出进行简单归一化，没有进行ImageNet标准化的反归一化
- **影响**：导致图像颜色失真，变成黑白或颜色异常

### 2. 风格迁移输出处理不当
- **问题**：`algorithm_service.py`中对`style_output`的处理逻辑不完整
- **影响**：风格迁移结果显示异常

### 3. 图像格式转换问题
- **问题**：没有正确处理CHW和HWC格式转换
- **影响**：可能导致颜色通道处理不正确

## 修复方案

### 1. 添加ImageNet反归一化函数
在`onnx_service.py`中添加了`denormalize_image`方法：

```python
def denormalize_image(self, image: np.ndarray) -> np.ndarray:
    """
    反归一化图像，将ImageNet标准化的图像转换回[0,255]范围
    """
    # 复制数组避免修改原数据
    img = image.copy()
    
    # 反标准化
    for i in range(3):
        img[i] = img[i] * self.imagenet_std[0, 0, i] + self.imagenet_mean[0, 0, i]
    
    # 转换为HWC格式
    img = np.transpose(img, (1, 2, 0))
    
    # 限制到[0,1]范围并转换为[0,255]
    img = np.clip(img, 0, 1)
    img = (img * 255).astype(np.uint8)
    
    return img
```

### 2. 修复风格迁移输出处理
在`algorithm_service.py`中改进了风格迁移输出的处理逻辑：

```python
# 检查输出形状，确保是 [C, H, W] 格式
if style_data.ndim == 3 and style_data.shape[0] in (1, 3):
    # 已经是 CHW 格式，直接使用反归一化
    style_img = onnx_service.denormalize_image(style_data)
    converted_image = Image.fromarray(style_img)
elif style_data.ndim == 3 and style_data.shape[2] in (1, 3):
    # 是 HWC 格式，需要转换为 CHW 再反归一化
    style_chw = np.transpose(style_data, (2, 0, 1))
    style_img = onnx_service.denormalize_image(style_chw)
    converted_image = Image.fromarray(style_img)
```

### 3. 改进异常掩码处理
优化了异常掩码的处理逻辑，支持不同维度的掩码：

```python
# 处理不同维度的掩码
if mask.ndim == 3 and mask.shape[0] == 1:
    mask_2d = mask[0]
elif mask.ndim == 2:
    mask_2d = mask
else:
    # 如果形状不符合预期，尝试取第一个通道
    mask_2d = mask.reshape(-1, mask.shape[-1]) if mask.ndim > 2 else mask
```

### 4. 添加热力图叠加功能
实现了彩色热力图叠加功能，使异常图像显示为彩色热力图：

```python
def create_heatmap_overlay(self, image: np.ndarray, mask: np.ndarray, alpha: float = 0.6) -> np.ndarray:
    """
    创建热力图叠加图像
    """
    # 归一化掩码到[0,1]
    mask_norm = (mask - mask.min()) / (mask.max() - mask.min() + 1e-8)
    
    # 创建热力图颜色映射 (使用jet colormap)
    colormap = plt.cm.jet
    heatmap = colormap(mask_norm)[:, :, :3]  # 去掉alpha通道
    heatmap = (heatmap * 255).astype(np.uint8)
    
    # 叠加图像
    overlay = cv2.addWeighted(image, 1-alpha, heatmap, alpha, 0)
    
    return overlay
```

### 5. 修复异常图像输出
将异常图像从灰度图像改为彩色热力图叠加图像：

```python
# 创建彩色热力图叠加图像
query_array = np.array(query_rgb)
overlay = onnx_service.create_heatmap_overlay(query_array, mask_resized)
anomaly_image = Image.fromarray(overlay)
```

## 修复效果验证

通过测试验证了以下功能：

1. ✅ **反归一化函数正确性**：能够正确将ImageNet标准化的图像转换回[0,255]范围
2. ✅ **图像处理流程完整性**：预处理→推理→反归一化→输出全流程正常
3. ✅ **颜色保持能力**：红色、绿色、蓝色图像处理后能正确保持颜色特征
4. ✅ **输出格式正确性**：确保输出为彩色图像而非黑白图像

## 技术细节

### ImageNet标准化参数
```python
IMAGENET_MEAN = [0.485, 0.456, 0.406]
IMAGENET_STD = [0.229, 0.224, 0.225]
```

### 反归一化公式
```python
# 对于每个通道 i:
img[i] = img[i] * IMAGENET_STD[i] + IMAGENET_MEAN[i]
```

### 数据格式转换
- 输入：`[C, H, W]` (CHW格式)
- 输出：`[H, W, C]` (HWC格式)
- 数据类型：`uint8`
- 值范围：`[0, 255]`

## 修复文件清单

1. `app/services/onnx_service.py` - 添加反归一化函数、热力图叠加功能
2. `app/services/algorithm_service.py` - 修复风格迁移和异常掩码处理

## 测试结果

所有测试通过，确认修复成功：
- 反归一化测试通过
- 图像处理流程测试通过  
- 颜色保持测试通过
- 热力图叠加测试通过
- 异常图像彩色化测试通过

修复后的后端现在能够正确返回彩色图像，风格迁移结果和异常图像都会正确显示为彩色。

# 前端与后端连接测试指南

## 🚀 快速测试步骤

### 1. 后端服务状态检查
```bash
# 检查端口是否被占用
netstat -an | findstr :8000

# 如果端口被占用，重启后端服务
python -m app.main
```

### 2. 基础连接测试
```bash
# 运行连接测试
python test_frontend_connection.py
```

### 3. 手动测试API
```bash
# 健康检查
curl http://127.0.0.1:8000/

# 测试CORS（需要重启服务器后生效）
curl -H "Origin: http://localhost:3000" http://127.0.0.1:8000/
```

## 🔧 前端集成代码

### JavaScript/TypeScript 示例
```javascript
const API_BASE_URL = 'http://127.0.0.1:8000';

// 1. 健康检查
async function checkBackend() {
    try {
        const response = await fetch(`${API_BASE_URL}/`);
        const data = await response.json();
        console.log('后端状态:', data);
        return true;
    } catch (error) {
        console.error('后端连接失败:', error);
        return false;
    }
}

// 2. 上传并处理图片
async function processImages(queryFile, gerberFile) {
    const formData = new FormData();
    formData.append('query', queryFile);
    formData.append('gerber', gerberFile);
    formData.append('model', '256');
    
    try {
        const response = await fetch(`${API_BASE_URL}/api/process`, {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            const result = await response.json();
            console.log('处理结果:', result);
            return result;
        } else {
            throw new Error(`HTTP ${response.status}: ${await response.text()}`);
        }
    } catch (error) {
        console.error('处理失败:', error);
        throw error;
    }
}

// 3. 显示返回的图片
function displayResultImages(result) {
    // 显示转换后的Gerber图
    if (result.convertedGerber) {
        const img1 = document.createElement('img');
        img1.src = `data:image/png;base64,${result.convertedGerber}`;
        img1.style.maxWidth = '300px';
        document.body.appendChild(img1);
    }
    
    // 显示异常检测图
    if (result.anomalyImage) {
        const img2 = document.createElement('img');
        img2.src = `data:image/png;base64,${result.anomalyImage}`;
        img2.style.maxWidth = '300px';
        document.body.appendChild(img2);
    }
}
```

### React 示例
```jsx
import React, { useState } from 'react';

function ImageProcessor() {
    const [result, setResult] = useState(null);
    const [loading, setLoading] = useState(false);

    const handleFileUpload = async (queryFile, gerberFile) => {
        setLoading(true);
        try {
            const formData = new FormData();
            formData.append('query', queryFile);
            formData.append('gerber', gerberFile);
            formData.append('model', '256');

            const response = await fetch('http://127.0.0.1:8000/api/process', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                const data = await response.json();
                setResult(data);
            } else {
                throw new Error(`处理失败: ${response.status}`);
            }
        } catch (error) {
            console.error('上传失败:', error);
        } finally {
            setLoading(false);
        }
    };

    return (
        <div>
            {loading && <p>处理中...</p>}
            {result && (
                <div>
                    <p>异常分数: {result.anomalyScore}</p>
                    <p>缺陷描述: {result.defectDescription}</p>
                    {result.convertedGerber && (
                        <img src={`data:image/png;base64,${result.convertedGerber}`} alt="转换后图片" />
                    )}
                    {result.anomalyImage && (
                        <img src={`data:image/png;base64,${result.anomalyImage}`} alt="异常检测图" />
                    )}
                </div>
            )}
        </div>
    );
}
```

## 🐛 常见问题解决

### 1. CORS 错误
**问题**: `Access to fetch at 'http://127.0.0.1:8000' from origin 'http://localhost:3000' has been blocked by CORS policy`

**解决**: 
- 重启后端服务器
- 检查 `app/main.py` 中的 CORS 配置
- 确保 `CORSMiddleware` 正确添加

### 2. 连接被拒绝
**问题**: `Failed to fetch` 或 `Connection refused`

**解决**:
- 检查后端服务是否运行: `netstat -an | findstr :8000`
- 重启后端服务: `python -m app.main`
- 检查防火墙设置

### 3. 文件上传失败
**问题**: `422 Unprocessable Entity`

**解决**:
- 确保文件格式正确 (PNG, JPG, JPEG)
- 检查文件大小限制 (10MB)
- 确保 FormData 字段名正确: `query`, `gerber`

## 📊 测试结果验证

### 成功的响应示例
```json
{
    "convertedGerber": "iVBORw0KGgoAAAANSUhEUgAA...", // base64图片
    "anomalyImage": "iVBORw0KGgoAAAANSUhEUgAA...",   // base64图片
    "anomalyScore": 0.48133617639541626,
    "defectDescription": "轻微缺陷（置信度: 48.1%）：建议定期检查"
}
```

### 测试检查清单
- [ ] 后端服务运行正常 (端口8000)
- [ ] 健康检查返回200状态码
- [ ] CORS头信息正确返回
- [ ] 图片上传接口响应正常
- [ ] 图片处理接口返回结果
- [ ] 返回的图片可以正确显示

## 🚀 部署建议

### 开发环境
- 后端: `http://127.0.0.1:8000`
- 前端: `http://localhost:3000` (React) 或 `http://localhost:5173` (Vite)

### 生产环境
- 修改 `app/main.py` 中的 CORS 配置，指定具体的前端域名
- 使用环境变量管理API地址
- 考虑使用反向代理 (Nginx) 处理跨域
